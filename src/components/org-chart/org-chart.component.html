<div class="relative w-full min-h-full overflow-hidden" (mousedown)="onPanStart($event)">
  <!-- Zoom Controls -->
  <div class="absolute top-0 right-0 z-10 flex items-center space-x-1 bg-white/60 backdrop-blur-sm border border-slate-200 rounded-lg p-1">
    <button (click)="zoomOut()" class="p-1.5 text-slate-600 hover:bg-slate-200 rounded-md transition-colors" aria-label="Zoom out">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
    </button>
    <span class="text-sm font-medium text-slate-600 w-12 text-center select-none" aria-live="polite">
      {{ Math.round(zoomLevel() * 100) }}%
    </span>
    <button (click)="zoomIn()" class="p-1.5 text-slate-600 hover:bg-slate-200 rounded-md transition-colors" aria-label="Zoom in">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
    </button>
  </div>
  
  <div class="pt-12"
       [class.cursor-grab]="!isPanning()"
       [class.cursor-grabbing]="isPanning()"
       [class.transition-transform]="!isPanning()"
       [class.duration-300]="!isPanning()"
       [class.ease-in-out]="!isPanning()"
       [style.transform]="'translate(' + panOffset().x + 'px, ' + panOffset().y + 'px) scale(' + zoomLevel() + ')'"
       [style.transform-origin]="'top center'">
    <div class="flex justify-center">
      <div class="flex flex-col items-center text-center">
        <!-- Level 1: CEO / Director -->
        <div class="p-3 bg-white rounded-lg shadow-sm border border-slate-200 inline-block">
          <div class="w-20 h-20 rounded-full p-1 mx-auto" [class]="treeData().avatarColor">
            <img [src]="treeData().avatar" [alt]="treeData().name" class="w-full h-full rounded-full object-cover">
          </div>
          <h3 class="mt-2 font-bold text-slate-800">{{ treeData().name }}</h3>
          <p class="text-xs text-slate-500">{{ treeData().role }}</p>
        </div>

        <!-- Connector to Level 2 -->
        @if (treeData().children && treeData().children.length > 0) {
          <div class="w-px h-8 bg-slate-300"></div>
        }

        <!-- Level 2: Managers -->
        <div class="flex justify-center relative">
          <!-- Horizontal Line -->
          <div class="absolute top-0 left-1/2 right-1/2 h-px bg-slate-300" style="left: 2rem; right: 2rem;"></div>

          @for (manager of treeData().children; track manager.id) {
            <div class="flex flex-col items-center px-4">
              <!-- Vertical Connector from Horizontal Line -->
              <div class="w-px h-8 bg-slate-300"></div>

              <div class="p-3 bg-white rounded-lg shadow-sm border border-slate-200 inline-block transition-all duration-200"
                  (dragover)="handleDragOver($event, manager)"
                  (dragleave)="handleDragLeave()"
                  (drop)="handleDrop($event, manager)"
                  [class.ring-2]="dropTargetId() === manager.id"
                  [class.ring-blue-400]="dropTargetId() === manager.id"
                  [class.bg-blue-50]="dropTargetId() === manager.id"
                  [class.scale-105]="dropTargetId() === manager.id">
                <div class="w-16 h-16 rounded-full p-1 mx-auto" [class]="manager.avatarColor">
                  <img [src]="manager.avatar" [alt]="manager.name" class="w-full h-full rounded-full object-cover">
                </div>
                <h4 class="mt-2 font-semibold text-slate-800 text-sm">{{ manager.name }}</h4>
                <p class="text-xs text-slate-500">{{ manager.role }}</p>
              </div>

              <!-- Connector to Level 3 -->
              @if (manager.children && manager.children.length > 0) {
                <div class="w-px h-8 bg-slate-300"></div>
              }

              <!-- Level 3: Sub-Managers -->
              <div class="flex justify-center relative">
                @if (manager.children && manager.children.length > 1) {
                  <div class="absolute top-0 h-px bg-slate-300" style="left: 1.5rem; right: 1.5rem;"></div>
                }
                @for (sub of manager.children; track sub.id) {
                  <div class="flex flex-col items-center px-2">
                    <!-- Vertical Connector from Horizontal Line -->
                    @if (manager.children && manager.children.length > 1) {
                      <div class="w-px h-8 bg-slate-300"></div>
                    }

                    <div class="p-2 bg-white rounded-lg shadow-sm border border-slate-200 inline-block cursor-move transition-all duration-200"
                          draggable="true"
                          (dragstart)="handleDragStart(sub, manager, $event)"
                          (dragend)="handleDragEnd()"
                          [class.opacity-40]="draggedNodeInfo()?.node.id === sub.id"
                          [class.scale-105]="draggedNodeInfo()?.node.id === sub.id"
                          [class.rotate-2]="draggedNodeInfo()?.node.id === sub.id"
                          [class.shadow-xl]="draggedNodeInfo()?.node.id === sub.id">
                      <div class="w-14 h-14 rounded-full p-1 mx-auto" [class]="sub.avatarColor">
                          <img [src]="sub.avatar" [alt]="sub.name" class="w-full h-full rounded-full object-cover">
                      </div>
                      <h5 class="mt-1 font-medium text-slate-700 text-xs">{{ sub.name }}</h5>
                      <p class="text-xs text-slate-500">{{ sub.role }}</p>
                    </div>

                    <!-- Connector to Employees -->
                    @if (sub.employees) {
                      <div class="w-px h-6 bg-slate-200"></div>
                      <div class="w-full space-y-1">
                          @for (item of [].constructor(sub.employees); track $index) {
                            <div class="w-24 h-6 bg-blue-100/50 border border-blue-200 rounded-md flex items-center justify-center text-xs text-blue-700">Employee</div>
                          }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>